version: '3.8' 

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: payment-and-commission-platform
    restart: always

    # Mapeamento de portas - mantido em 3005
    ports:
      - "3005:3005"

    environment:
      - NODE_ENV=production
      - PORT=3005
      - HOST=0.0.0.0
      # Removido HOSTNAME=0.0.0.0 (isso só confunde o Node)
      # Define o IP real ou domínio público do servidor:
      - PUBLIC_HOST=http://82.25.66.17:3005
      - NEXT_PUBLIC_SITE_URL=http://82.25.66.17:3005
      - NEXT_TELEMETRY_DISABLED=1
      - NEXT_USE_TURBOPACK=0

      ## Banco de dados
      #- DB_HOST=${DB_HOST:-192.168.1.193}
      #- DB_PORT=${DB_PORT:-3306}
      #- DB_USER=${DB_USER:-Indicadores}
      #- DB_PASSWORD=${DB_PASSWORD:-xEth+vOHltr*c4Eju3+t}
      #- DB_NAME=${DB_NAME:-indicadores}

    env_file:
      - .env

    # Healthcheck - apontando para uma rota válida do Next.js
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 25s

    # Início do servidor
    command: node server-start.js

    labels:
      - "coolify.managed=true"
      - "coolify.service=app"

    networks:
      - app-network

networks:
  app-network:
    driver: bridge
