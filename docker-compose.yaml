version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: payment-and-commission-platform
    restart: always

    # Mapeamento de portas - mantém 3005 para acessar via IP:PORTA
    ports:
      - "3005:3005"

    environment:
      # Execução Next.js/Node
      NODE_ENV: production
      PORT: "3005"
      HOST: "0.0.0.0"
      NEXT_TELEMETRY_DISABLED: "1"
      NEXT_USE_TURBOPACK: "0"

      # URL pública (use IP real + porta)
      PUBLIC_HOST: "http://82.25.66.17:3005"
      NEXT_PUBLIC_SITE_URL: "http://82.25.66.17:3005"

      # Banco de dados (evite defaults aqui; deixe no .env)
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME}"

      # Opcional: aumentar timeout de conexão do driver (em ms, depende da lib)
      # DB_CONNECT_TIMEOUT: "15000"

    # Carrega variáveis do .env (terão precedência se não forem sobrescritas acima)
    env_file:
      - .env

    # Healthcheck: use Node (sempre existe) em vez de curl/wget (podem não existir na imagem)
    # Tente apontar para uma rota que retorne 200 (ex.: /api/health). Ajuste se necessário.
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:3005/api/health', r => process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))\""
        ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 25s

    # Início do servidor (confira se este arquivo realmente inicia seu Next)
    command: node server-start.js

    labels:
      - "coolify.managed=true"
      - "coolify.service=app"

    networks:
      - app-network

networks:
  app-network:
    driver: bridge
